<html>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script  src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://kit.fontawesome.com/7b0276e0ce.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@duetds/date-picker@1.4.0/dist/duet/duet.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@duetds/date-picker@1.4.0/dist/duet/duet.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/css-toggle-switch@latest/dist/toggle-switch.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@duetds/date-picker@1.4.0/dist/duet/themes/default.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" href="/static/index.css">
    <link rel="stylesheet" href="/static/new-task.css">
    <link rel="stylesheet" href="/static/switch.css">
    
    <style>
        @font-face {
            font-family: "Open 24 Display St";
            src: url("/static/Open\ 24\ Display\ St.ttf");
        }
        #sidebar {
            position: absolute;
            background-color: aquamarine;
            margin: 0;
            padding: 20px;
            padding-top: 90px;
            display: inline-block;
            top: 0%;
            left: 0%;
            width: 15%;
            height: 100%;
        }
        #topbar {
            position: absolute;
            left: 15%;
            height: 5%;
            width: 100%;
            background-color: rgba(225, 225, 225);
        }
        .sidebar-li {
            margin: 5px;
            margin-top: 40px;
            padding-top: 5px;
            padding-left: 15px;
            padding-bottom: 5px;
            width: 100%;
            border-radius: 10px;
            font-family: "Ubuntu Mono";
            font-weight: bold;
            font-size: 16pt;
            text-align: left;
            list-style: none;
            cursor: pointer;
            transition: color 0.5s, background-color 0.5s;
        }
        .sidebar-li a {
            text-decoration: none;
            color: black;
        }
        .sidebar-li:hover {
            background-color: black; 
            color: aquamarine;
        }
        .active {
            background-color: black; 
            color: aquamarine;
        }
        .inactive {
            background-color: aquamarine; 
            color: black;
        }
        #calendar_area th {
            border: solid;
            border-width: 15px 15px 0px 15px;
            border-color: mediumorchid;
            text-align: left;
        }
        .calendar_area_enable {
            width: 100px;
            height: 100px;
            background-color: rgb(255, 255, 255, 0.7);
            border: solid;
            border-width: 15px;
            border-color: mediumorchid;
            cursor: pointer;
        }
        .calendar_area_disable {
            width: 100px;
            height: 100px;
            background-color: rgb(255, 255, 255, 0.3);
            border: solid;
            border-width: 15px;
            border-color: mediumorchid;
            cursor: default;
        }
        #calendar_area {
            position: absolute; 
            left: 20%; 
            top: 10%; 
            width: 700px; 
            background-color: mediumorchid; 
            color: white; 
            border-radius: 10px;
            box-shadow:2px 2px 2px 1px #cccccc;
            animation: down-slidein 1.5s;
        }
        #task_area {
            position: absolute; 
            right: 10%; 
            top: 10%; 
            width: 30%; 
            height: 500px; 
            background-color: wheat; 
            border-radius: 10px;
            box-shadow:2px 2px 2px 1px #cccccc;
            animation: left-slidein 1.5s;
        }
        #user {
            position: absolute; 
            bottom: 5%; 
            width: 15%; 
            color: white; 
            background-color: gray; 
            height: 45px; 
            font-size: 18pt; 
            padding: 5px;   
            text-align: left; 
            padding-left: 15px;
        }
        .calendar_area_enable:hover {
            background-color: rgba(255, 255, 255, 1);
        }
        #user:hover {
            background-color: rgb(150, 150, 150, 0.7);
        }
        .list-group button:hover {
            background: rgba(124, 252, 0, 0.5);
        }
        #schedule-title {
            position: absolute; 
            left: 20%; 
            top: 10%; 
            width: 35%;
            color: black; 
            border-radius: 10px;
            box-shadow:2px 2px 2px 1px #cccccc;
            background-color: rgb(255, 195, 82);
            border-radius: 10px;
            padding: 50px;
            animation: fadin 1.5s;
        }
        #schedule-info {
            position: absolute; 
            left: 20%; 
            top: 30%; 
            width: 35%;
            border-radius: 10px;
            background-color: rgb(192, 248, 192);
            box-shadow:2px 2px 2px 1px #cccccc;
            padding: 50px;
        }
        #schedule-img {
            position: absolute; 
            left: 60%; 
            top: 10%; 
            width: 35%;
            height: 60%;
            color: black; 
            border-radius: 10px;
            padding: 50px;
            text-align: center;
            animation: fadin 3s;
            box-shadow:2px 2px 2px 1px #cccccc;
        }
        #schedule-img img {
            width: auto;
            height: 100%;
            border-radius: 10px;
            animation: fadin 3s 0.5s;
            box-shadow:2px 2px 2px 1px #cccccc;
        }
        @keyframes fadeout {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        @keyframes fadin {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes down-slidein {
            from {
                top: 0;
                opacity: 0;
            }
            to {
                top: 10%;
                opacity: 1;
            }
        }
        @keyframes left-slidein {
            from {
                right: 0;
                opacity: 0;
            }
            to {
                right: 10%;
                opacity: 1;
            }
        }
    </style>
    <body>
        <div id="sidebar-area">
            <a id="index" href="./" style="z-index: 1;"> CalendarBox </a>
            <div id="sidebar">
                <li class="sidebar-li active" id="li_index">
                    <i class="fas fa-address-card" style="width: 24px; height: 24px;"></i>
                    <a> 待做事項 - 主頁 </a>
                </li>
                <li class="sidebar-li inactive" id="li_addSchedule">
                    <i class="fas fa-pen" style="width: 24px; height: 24px;" ></i>
                    <a> 新增行程 </a>
                </li>
                <li class="sidebar-li inactive" id="li_setting">
                    <i class="fas fa-cogs" style="width: 24px; height: 24px;"></i>
                    <a> 設定 </a>
                </li>
                <li class="sidebar-li inactive" id="li_logout">
                    <i class="fas fa-sign-out-alt" style="width: 24px; height: 24px; color: inherit;"></i>
                    <a style="color: inherit;"> 登出 </a>
                </li>
            </div>
            <div id="user">
                <i class="fas fa-running"></i>
                <a id="user_email"> </a>
            </div>
        </div>
        <div id="main-area" style="visibility: visible;">
            <div id="calendar_area">
                <div id="calendar_title" style="height: 20%; width: 100%; padding: 50px; padding-bottom: 0px;">
                    <h2> 2022 一月 </h2>
                    <table style="width: 100%; text-align: center; margin-top: 30px; color: white;">
                        <thead>
                            <th> 星期日 </th>
                            <th> 星期一 </th>
                            <th> 星期二 </th>
                            <th> 星期三 </th>
                            <th> 星期四 </th>
                            <th> 星期五 </th>
                            <th> 星期六 </th>
                        </thead>
                    </table>
                </div>
                <div id="calendar_main" style="width: 100%; height: 100%; padding: 50px; padding-top: 0px; margin: 0;">
                    <table id="calendar">

                    </table>
                </div>
            </div>
            <div id="task_area">
                <div style="padding: 50px;">
                    <h2> 待做事項 </h2>
                    <ul id="todo-ul" class="list-group" style="margin-top: 30px;">
                    </ul>
                </div>
            </div>
        </div>
        <div id="sub-area" style="visibility: hidden;">
            <div id="schedule-title">
                <h2> 01/08 行程資訊 </h2>
            </div>
            <div id="schedule-img">
                <img src="https://images.pexels.com/photos/3680219/pexels-photo-3680219.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500">
            </div>
            <div id="schedule-info">
                <div class="list-group">
                    <a class="list-group-item list-group-item-action active"> 吃飯 </a>
                    <a class="list-group-item list-group-item-action"> 看電影</a>
                    <a class="list-group-item list-group-item-action"> 吃點心</a>
                    <a class="list-group-item list-group-item-action disabled"> 玩 </a>
                  </div>
            </div>
        </div>
        <div id="add-new-task" style="visibility: hidden; font-size: 18px;">
            <div id="new-task-area">
                <div id="main_area" style="float: left; width: 50%; height: 100%;">
                    <h2> 新增行程 </h2>
                    <label style="margin-top: 50px;"> 行程名稱 </label>
                    <input type="text" class="form-control" id="schedule_data_title"> </input>

                    <label style="margin-top: 30px;"> 行程時間（開始） </label>
                    <duet-date-picker identifier="date" id="schedule_data_start_time"></duet-date-picker>

                    <label style="margin-top: 30px;"> 行程時間（結束） </label>
                    <duet-date-picker identifier="date" id="schedule_data_end_time"></duet-date-picker>

                    <label style="margin-top: 30px;"> 新增一張圖片 </label>
                    <input type="text" class="form-control" id="schedule_data_photo"> </input>

                    <label class="switch-light switch-candy" style="margin-top: 30px;" onclick="">
                        <input type="checkbox" id="schedule_data_open_deadline">

                        <strong>
                            開啟倒數器
                        </strong>

                        <span>
                            <span>Off</span>
                            <span>On</span>
                            <a></a>
                        </span>
                    </label>

                </div>
                <div id="note_area" style="float: right; width: 45%; height: 100%">
                    <h2> 　 </h2>
                    <label style="margin-top: 50px;"> 行程詳細 </label>
                    <textarea class="form-control" id="schedule_data_detail" rows="16"></textarea>
                    <button style="margin-top: 50px;" class="btn btn-primary btn-lg btn-block" onclick="upload_schedule()"> 完成 </button>
                    <button style="margin-top: 10px;" class="btn btn-secondary btn-lg btn-block"> 預覽 markdown </button>
                </div>
            </div>
        </div>
    </body>
    <!--  Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="/static/main.js"></script>

    <script>
        function sidebar_clear(){
            var li = ["li_index", "li_addSchedule", "li_setting", "li_logout"]
            for(var i = 0; i < li.length; i++){
                var item = document.getElementById(li[i]);
                item.setAttribute("class", "sidebar-li inactive")
            }
        }
        function area_clear(){
            var li = ["main-area", "sub-area", "add-new-task"]
            for(var i = 0; i < li.length; i++){
                var item = document.getElementById(li[i]);
                document.getElementById(li[i]).style.setProperty("visibility", "hidden");
            }
        }
        function animation_reset(){
            var div = ["calendar_area", "task_area", "new-task-area"]
            for(var i = 0; i < div.length; i++){
                var item = document.getElementById(div[i]);
                document.getElementById(div[i]).style.setProperty("animation", "none");
            }
        }
        function fetchSchedule(){

            var user_name = document.getElementById("user_email").innerText;

            var firebase_fetch = db.collection("schedule").doc(user_name);

            firebase_fetch.get().then((doc) => {
                var jsonData = doc.data();
                var keyList = Object.keys(jsonData);
                console.log(jsonData);
                for(var i = 0; i < keyList.length; i++){
                    var data = jsonData[keyList[i]];
                    var button = document.createElement("button");
                    var ul = document.getElementById("todo-ul");
                    console.log(data);
                    button.setAttribute("class", "list-group-item list-group-item-action");
                    button.innerText = data["start_time"] + " " + data["title"];
                    ul.append(button);
                }
            });
        }
    </script>
    <script>
        $.ajax({
            url: "./platform",
            type: "POST",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: function(data, status, xhr){
                console.log(data);
                var a = document.getElementById("user_email");
                a.innerText = data["name"];
                init();
                fetchSchedule();
            }
        });

        function init(){
            var table = document.getElementById("calendar");
            for(var i = 0; i < 6; i++){
                var tr = document.createElement("tr");
                for(var j = 0; j < 7; j++){
                    var td = document.createElement("td");

                    td.setAttribute("id", i.toString() + "-" + j.toString());
                    td.setAttribute("class", "calendar_area_enable");
                    td.style.setProperty("position", "relative");
                    td.style.setProperty("font-family", "Noto Sans");
                    td.style.setProperty("padding", "1%");

                    var span = document.createElement("span");
                    span.setAttribute("id", "calendar-date-" + i.toString() + "-" + j.toString())
                    span.style.setProperty("position", "absolute");
                    span.style.setProperty("top", "5%");
                    span.style.setProperty("left", "5%");

                    var count = document.createElement("span");
                    count.setAttribute("id", "calendar-count-" + i.toString() + "-" + j.toString())
                    count.style.setProperty("position", "absolute");
                    count.style.setProperty("left", "50%");
                    count.style.setProperty("buttom", "0%");
                    count.style.setProperty("font-size", "24pt");
                    count.style.setProperty("font-weight", "bold");
                    count.style.setProperty("white-space", "nowrap");
                    count.style.setProperty("transform", "translate(-50% , 0%)");

                    td.appendChild(span);
                    td.appendChild(count);

                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
            var index = document.getElementById("li_index");
            index.addEventListener("click", function(){
                animation_reset();
                sidebar_clear();
                area_clear();
                index.setAttribute("class", "sidebar-li active");
                document.getElementById("main-area").style.setProperty("visibility", "visible");
                document.getElementById("calendar_area").style.setProperty("animation", "down-slidein 1.5s");
                document.getElementById("task_area").style.setProperty("animation", "left-slidein 1.5s");
            });

            var addtask = document.getElementById("li_addSchedule");
            addtask.addEventListener("click", function(){
                animation_reset();
                sidebar_clear();
                area_clear();
                addtask.setAttribute("class", "sidebar-li active");
                document.getElementById("add-new-task").style.setProperty("visibility", "visible");
                document.getElementById("new-task-area").style.setProperty("animation", "down-slidein 1.5s");
            });

            var logout = document.getElementById("li_logout");
            logout.addEventListener("click", logout_func);

            drawCalendarNumber(2022, 1);

        }

        function logout_func(){
            Swal.fire({
                icon: 'success',
                title: "已登出",
                showConfirmButton: false,
                timer: 1500
            }).then((result) => {
                window.location.href = "./logout";
            });
        }
        
        function upload_schedule(){

            var title = document.getElementById("schedule_data_title");
            var start_time = document.getElementById("schedule_data_start_time");
            var end_time = document.getElementById("schedule_data_end_time");
            var photo_url = document.getElementById("schedule_data_photo");
            var deadline_option = document.getElementById("schedule_data_open_deadline");
            var detail = document.getElementById("schedule_data_detail");

            var user_schedule = {};
            var user_name = document.getElementById("user_email").innerText;

            var data = db.collection("schedule").doc(user_name);

            if (title.value === "" || start_time.value === "" || end_time.value === ""){
                Swal.fire({
                    icon: "error",
                    title: "必須要設定標題、開始時間與結束時間",
                    showConfirmButton: true
                });
                return;
            }

            data.get().then((doc) => {
                if(doc.exists){
                    user_schedule = doc.data();
                    console.log("Document data:", doc.data());
                }else{
                    console.log("No data");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            }).then(() => {

                console.log(user_schedule);


                var detail_string = detail.value.replace(/(?: |\r|\n|\r\n)/g, function(m) {
                    return m === " " ? "<sp>" : "<br>";
                });

                data_package = {}
                data_package["title"] = title.value;
                data_package["start_time"] = start_time.value;
                data_package["end_time"] = end_time.value;
                data_package["photo_url"] = photo_url.value;
                data_package["deadline_option"] = deadline_option.value;
                data_package["detail"] = detail_string;
                
                random_hash = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

                user_schedule[random_hash] = data_package;

                Swal.fire({
                    title: "上傳中",
                    showConfirmButton: false,
                    timer: 1500,
                    timerProgressBar: true,
                    didOpen: () => {
                        Swal.showLoading();
                        db.collection("schedule").doc(document.getElementById("user_email").innerText).set(user_schedule)
                        .then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: "上傳成功",
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            })
                        })
                        .catch((error) => {
                            console.error("Error writing document: ", error);
                        });
                    }
                });
            });
        }

        function drawCalendarNumber(year, month){
            var day = new Date(year, month-1, 1);
            var weekOfDay = day.getUTCDay();
            console.log(weekOfDay);
            var index = weekOfDay + 1;
            var countday = 1;
            var maxDay = new Date(year, month, 0).getDate();
            for(var i = index/7; countday <= maxDay; i++){
                for(var j = index%7; countday <= maxDay; index++){

                    var id = parseInt(index/7).toString() + "-" + parseInt(index%7).toString();
                    var td = document.getElementById(id);

                    console.log("calendar-count-" + id);

                    var date_span = document.getElementById("calendar-date-" + id);
                    var count_span = document.getElementById("calendar-count-" + id);

                    date_span.innerText = countday;
                    count_span.innerText = "50";
                    
                    td.addEventListener("click", function(){
                        area_clear();
                        document.getElementById("sub-area").style.setProperty("visibility", "visible");
                    });

                    countday += 1;
                }
            }
            for(var i = 0; i < 6; i++){
                for(var j = 0; j < 7; j++){
                    var span_id = "calendar-date-" + parseInt(i).toString() + "-" + parseInt(j).toString();
                    if(document.getElementById(span_id).innerText === ""){
                        var id = parseInt(i).toString() + "-" + parseInt(j).toString();
                        var td = document.getElementById(id);
                        td.setAttribute("class", "calendar_area_disable");
                    }
                }
            }
        }
    </script>
</html>