<html>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="./static/index.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
	<script  src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
	<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
			overflow-y: hidden;
            overflow-x: hidden;
		}
        #login {
            background-color: white; 
            display: inline-block; 
            width: 400px; 
            height: 500px;
            position: absolute;
			top: 45%; 
			left: 50%;
			font-family: "Microsoft YaHei UI";
			font-size: 30pt;
			margin: 1px;
			text-align: center;
			transform: translate(-50%, -50%);
            border-radius: 10px;
            border-style: solid;
            border-width: 1px;
            border-color: gray;
            animation: fadein 3s;
        }
        
        @keyframes fadein {
			0% {
				opacity: 0;
			}
			50% {
				opacity: 1;
			}
		}
        button:active {
			background-color: #3e8e41;
			box-shadow: 0 5px #666;
			transform: translateY(4px);
		}
    </style>
    <body>
        <div style="margin: 0; padding-top: 0px; position: relative;">
            <a id="index" href="./"> CalendarBox </a>
			<img src="./static/login.png" width="100%" height="auto"></img>
            <div id="login" style="padding: 20px;">
                <p style="margin-top: 34px;"> 註冊 </p>
                <div class="input-group" style="margin-top: 40px;">
                    <div id="email-div" class="input-group-prepend">
                        <span class="input-group-text">使用者名稱</span>
                      </div>
                      <input type="text" id="username" class="form-control">
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <div id="email-div" class="input-group-prepend">
                        <span class="input-group-text">信箱</span>
                      </div>
                      <input type="email" id="email" class="form-control">
                </div>
                <div class="input-group" style="margin-top: 20px;">
                    <div id="email-div" class="input-group-prepend">
                        <span class="input-group-text" >密碼</span>
                      </div>
                      <input type="password" id="password" class="form-control">
                </div>
                <button id="btn" class="btn btn-primary btn-lg btn-block" style="margin-top: 20px;" onclick="register()"> 註冊 </button>
                <div style="text-align: center; margin-top: 90px">
                    <a href="./login" style="font-size: 10pt; text-align: center;"> 已經有了帳號？登入 </a>
                </div>
            </div>
		</div>
    </body>
    <!--  Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="/static/main.js"></script>
    <script>
        var username = document.getElementById("username");
        var email = document.getElementById("email");
        var password = document.getElementById("password");
        username.addEventListener("keyup", function(event){
            if(event.keyCode == 13){
                event.preventDefault();
                document.getElementById("btn").click();
            }
        });
        email.addEventListener("keyup", function(event){
            if(event.keyCode == 13){
                event.preventDefault();
                document.getElementById("btn").click();
            }
        });
        password.addEventListener("keyup", function(event){
            if(event.keyCode == 13){
                event.preventDefault();
                document.getElementById("btn").click();
            }
        });
    </script>
    <script>
        function register(){
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;
            var username = document.getElementById("username").value;
            Swal.fire({
                title: "註冊中",
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
                didOpen: () => {
                    Swal.showLoading();
                    app.auth().createUserWithEmailAndPassword(email, password).then((userCredential) => {
                        var user = userCredential.user;
                        console.log("success");
                        Swal.fire({
                            icon: 'success',
                            title: "註冊成功！",
                            timer: 1500,
                            showConfirmButton: false
                        }).then((result) => {
                            user.updateProfile({
                                displayName: username
                            }).then(() => {
                                /* doing login */
                                user.getIdToken().then(tokenID => {
                                    jsonData = {}
                                    jsonData["email"] = email;
                                    jsonData["token"] = tokenID;
                                    requestURL = "./signin"
                                    $.ajax({
                                        url: requestURL,
                                        data: JSON.stringify(jsonData),
                                        type: "POST",
                                        dataType: "json",
                                        contentType: "application/json;charset=utf-8",
                                        success: function(data, status, xhr){
                                            firebase.auth().signOut();
                                            window.location.href = "./platform"
                                        },
                                        error: function(xhr, ajaxOptions, thrownError){
                                            console.log(xhr.status);
                                            console.log(thrownError);
                                        }
                                    });
                                })
                            })
                            /* that's all */
                        });
                    }).catch((error) => {
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        Swal.fire({
                            icon: 'error',
                            title: "註冊失敗",
                            text: error.message
                        });
                    });
                }
            });
        }
    </script>
</html>